# Auto-merges pull requests created by ArgoCD Image Updater.
# Approves the PR using AUTO_MERGE_PAT (or GITHUB_TOKEN fallback),
# then enables auto-merge so it lands once status checks pass.
name: Auto-merge image updater PRs

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    if: startsWith(github.head_ref, 'image-updater/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Approve PR
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.AUTO_MERGE_PAT || secrets.GITHUB_TOKEN }}
        run: gh pr review "${{ github.event.pull_request.number }}" --approve

      - name: Enable auto-merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh pr merge "${{ github.event.pull_request.number }}" --auto --squash --base master
